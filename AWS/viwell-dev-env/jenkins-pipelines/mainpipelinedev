def applicationName = "backendmain"
def envName = "dev"
def configName = "dev"
def clientId = "${applicationName}-${envName}"

// Helm Params
def branchName = "main"
def gitServicRepo = "git@github.com:VIWELL-Tech/api-v1-backend.git"
def EnvName = "dev"
def serviceName = "backendmain"
def registryId = "814880204573"
def awsRegion = "us-east-1"
def ecrUrl = "814880204573.dkr.ecr.us-east-1.amazonaws.com"
def awsProfile = ""
def k8sContext = "dev"
def awsCredsId = ""
def namespace = "dev"
def HelmNamespace = "dev"
def dockerfile = "api-backend-main/Dockerfile"
def helmDir = "${env}/Helm-charts"  
def newAppVersion = "${appVersion}"

// List of microservices
def microservices = [
    'api-gateway',
    'assessmentv2',
    'auth',
    'avatar',
    'booking',
    'category',
    'content',
    'email',
    'favorite',
    'general',
    'logger',
    'loyalty',
    'media',
    'notification',
    'organization',
    'personalisation',
    'pillar',
    'progress',
    'push-notification',
    'rbac',
    'review',
    'reward',
    'reward-partner',
    'schedular',
    'tag',
    'wearable',
    'wearable-connect'
]

node {
    try {
        notifyBuild('STARTED')

        stage('Update Helm chart version') {
            sh "rm -rf devops-argocd"
            sh "git clone git@github.com:VIWELL-Tech/devops-argocd.git"
            sh "ls && pwd"
            for (microservice in microservices) {
                script {
                   // sh "rm -rf * .[!.]*"
                    dir('devops-argocd') {  // Change directory to the cloned repository
                        // Update the Chart.yaml file with the new version
                        sh """
                            ls -la && pwd
                            sed -i 's/^appVersion:.*/appVersion: ${newAppVersion}/' ${helmDir}/${microservice}/Chart.yaml 
                            ls -ls && pwd
                            sed -i 's/^AppVersion:.*/AppVersion: ${newAppVersion}/' ${helmDir}/${microservice}/values.yaml
                            ls -ls && pwd
                        """
                    }
                }
            }
            script {
                dir('devops-argocd') {
                    sh """
                        git add .
                        git commit -m 'Updated charts to version ${newAppVersion}'
                        git push origin main
                    """
                }
            }
        }
       
    } catch (e) {
        currentBuild.result = "FAILED"
        throw e
    } finally {
        notifyBuild(currentBuild.result)
    }
}

def notifyBuild(String buildStatus = 'STARTED') {
    buildStatus = buildStatus ?: 'SUCCESSFUL'
    def colorCode = buildStatus == 'SUCCESSFUL' ? '#00FF00' : '#FF0000'
    def summary = "${buildStatus}: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]' (${env.BUILD_URL})"
    slackSend(color: colorCode, message: summary)
}
